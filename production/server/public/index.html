<!DOCTYPE html>
<html>
<head>
    <title>Volvo Demo</title>

    <style>
        /* Have each SVG container take up half of the screen and align them
           horizontally next to each other ot the left. */
        .svgcontainer {
            width:100%;
            float:left;
        }
    </style>

    <!-- Load jQuery from Google's CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

    <!-- Include RelayClient for PubSub system -->
    <script type="text/javascript" src="js/relay-client.js"></script>
    <!-- Include VolvoSurface for PubSub loading and modifying SVGs -->
    <script type="text/javascript" src="js/volvoSurface.js"></script>
    <script type="text/javascript">
        function remapValue(val) {
            // return 100 - (50 / 1000 * val);
            return 100-(val/10);
        };

        // wait until DOM is loaded, then call function
        $(document).ready(function () {
            // initialise new object and load the given SVGs into the DOM
            // elements given by the provided CSS selectors, i.e.
            // byborre_volvo_plan.svg is loaded from the server and its content
            // placed into the DOM element with id 'plan'.
            var volvoSurface = new VolvoSurface({
                "#graphic": "img/volvo_graphic.svg",
            });

            // wait until all given SVGs are successfully loaded, then call function
            volvoSurface.loaded(function () {
                // connect to PubSub system
                var host = window.location.hostname;
                var relay = new RelayClient("ws://" + host + ":23148");

                // subscribe to channel 'pressure' and call function everytime a
                // message is received. A message has the following format:
                //   { "1": 500, "2": 345, "3": 547, "4": 853 }
                // Where the keys are sensor IDs and the values the corresponding
                // pressure values.
                relay.subscribe('pressure', function (values) {
                    // iterate through the received dictionary
                    for (var key in values) {
                        if (values.hasOwnProperty(key)) {
                            // adjust value to a range from 50 to 100 for lightness
                            // (50 => base colour; 100 => white)
                            lightness = remapValue(values[key]);
                            // Compute identifiers for polygons (and error messages)
                            // Note the _2_ is some artefact of AI exporting to SVG that we don't understand.
							var key_3d = "#threed" + key + "_2_";
							var key_plan = "#plan" + key + "_2_";
							var key_side = "#side" + key + "_1_";
							var key_error = "#node" + key;
							// Hand remains TBD
							// Swipe remains TBD
							
                            // set the resulting lightness of the various polygons whose number
                            // match the dictionary key in the perspective SVG
                            
                            $("#graphic").polygon(key_3d).setHSLA(120, 0, lightness, 1.0);
                            $("#graphic").polygon(key_plan).setHSLA(120, 0, lightness, 1.0);
                            $("#graphic").polygon(key_side).setHSLA(120, 0, lightness, 1.0);

                            // Enable any node in the html that waits for this event
                            if (values[key]) $(key_error).attr("style", "");
                        }
                    }
                });
            });
            // Reset error messages by clicking on them
            $(".errors span").click(function() {
            	$(this).attr("style", "display: none");
			});
        });
    </script>
</head>
<body>
	<div class="errors">
		<span id="node1noResponse" style="display: none">Jeenode #1 not responding</span>
		<span id="node1badResponse" style="display: none">Jeenode #1 bad response to poll request</span>
		<span id="node1lowBattery" style="display: none">Jeenode #1 battery low</span>
		<span id="node2noResponse" style="display: none">Jeenode #2 not responding</span>
		<span id="node2badResponse" style="display: none">Jeenode #2 bad response to poll request</span>
		<span id="node2lowBattery" style="display: none">Jeenode #2 battery low</span>
		<span id="node3noResponse" style="display: none">Jeenode #3 not responding</span>
		<span id="node3badResponse" style="display: none">Jeenode #3 bad response to poll request</span>
		<span id="node3lowBattery" style="display: none">Jeenode #3 battery low</span>
	</div>
		
    <div class="svgcontainer" id="graphic">
    </div>
</body>
</html>
